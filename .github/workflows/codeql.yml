name: "CodeQL Security Analysis"

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main", "develop" ]
  schedule:
    - cron: '0 6 * * 1'
  workflow_dispatch:

env:
  RUBY_VERSION: 3.4.4

jobs:
  codeql-ruby:
    name: CodeQL Ruby Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      actions: read
      contents: read
      security-events: write
      packages: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: ${{ env.RUBY_VERSION }}
        bundler-cache: true

    - name: Install system dependencies for Ruby
      run: |
        sudo apt-get update
        sudo apt-get install -y libmysqlclient-dev libpq-dev libsqlite3-dev

    - name: Set up Ruby environment variables
      run: |
        echo "DATABASE_ADAPTER=sqlite" >> $GITHUB_ENV
        echo "DATABASE_NAME=codeql_analysis.db" >> $GITHUB_ENV
        echo "APP_ENV=test" >> $GITHUB_ENV
        echo "APP_SECRET=codeql_test_secret_key" >> $GITHUB_ENV
        echo "JWT_SECRET=codeql_test_jwt_secret" >> $GITHUB_ENV
        bundle install

    - name: Initialize CodeQL for Ruby
      uses: github/codeql-action/init@v3
      with:
        languages: ruby
        queries: security-extended

    - name: Setup test database for CodeQL
      run: |
        bundle exec ruby -e "
          require './lib/database'
          begin
            SourceLicense::Database.setup
            puts 'Database setup completed'
          rescue => e
            puts 'Database setup failed: #{e.message}'
          end
        " || echo "Proceeding without DB setup"

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:ruby"

  codeql-js:
    name: CodeQL JavaScript Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 120
    permissions:
      actions: read
      contents: read
      security-events: write
      packages: read

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Initialize CodeQL for JavaScript
      uses: github/codeql-action/init@v3
      with:
        languages: javascript
        queries: security-extended

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3
      with:
        category: "/language:javascript"

  security-review:
    name: Security Code Review
    runs-on: ubuntu-latest
    needs: [codeql-ruby, codeql-js]
    if: always()

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: